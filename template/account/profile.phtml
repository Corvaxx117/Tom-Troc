<!--
    Template "Mon compte"
    ======================
    Cette page permet à l'utilisateur connecté de :
    - Consulter et modifier ses informations personnelles (email, pseudo, mot de passe, avatar)
    - Visualiser le nombre de livres dans sa bibliothèque
    - Ajouter un nouveau livre via une fenêtre modale (avec image, titre, auteur, description et disponibilité)
    - Consulter la liste de ses livres sous forme de tableau, avec tri possible
    - Éditer ou supprimer chaque livre
-->

<section class="profile-wrapper">
    <h1>Mon compte</h1>
    <!-- Affichage des informations personnelles -->
    <div class="profile-container">
        <!-- Formulaire de mise à jour des informations de l'utilisateur -->
        <form method="post" action="<?= $this->url('/account/update') ?>" enctype="multipart/form-data" class="profile-form">
            <div class="profile-left">
                <div class="profile-avatar">
                    <label for="avatarInput" style="cursor: pointer;">
                        <img id="avatarPreview" src="<?= IMG_PATH . $user->getAvatar() ?>" alt="Avatar utilisateur">
                    </label>
                    <input type="file" id="avatarInput" name="avatar" accept="image/*" class="file-input">
                    <a href="#" class="edit-avatar" onclick="document.getElementById('avatarInput').click(); return false;">modifier</a>
                </div>

                <div class="profile-username"><?= $this->clean($user->getName(), false) ?></div>
                <div class="profile-meta">Membre depuis 1 an</div>
                <div class="profile-library">
                    <div class="label">Bibliothèque</div>
                    <div class="value"><i class="fa-solid fa-book"></i> <?= count($books) ?? 0 ?> livres</div>
                </div>
            </div>

            <div class="profile-right">
                <h2>Vos informations personnelles</h2>

                <label>Adresse email</label>
                <input type="email" name="email" value="<?= $this->clean($user->getEmail(), false) ?>">

                <label>Mot de passe (laissez vide pour ne pas le modifier)</label>
                <input type="password" name="password" value="">

                <label>Pseudo</label>
                <input type="text" name="name" value="<?= $this->clean($user->getName(), false) ?>">

                <button class="btn-green" type="submit">Enregistrer</button>
            </div>
        </form>
    </div>
    <!-- Bouton d’ouverture de la modale d'ajout de livre -->
    <button class="btn-add-book btn-green">+ Ajouter un livre</button>
</section>

<!-- Fenêtre modale d'ajout de livre -->
<div id="bookModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 class="page-title">Ajouter un livre</h2>
        <!-- Formulaire d'ajout de livre -->
        <form action="<?= $this->url('/account/book/create') ?>" method="POST" enctype="multipart/form-data" class="edit-book-form">
            <div class="form-grid">

                <!-- Colonne image -->
                <div class="form-image">
                    <p>Photo de couverture</p>
                    <img id="bookImagePreview" src="<?= IMG_PATH ?>/uploads/books/book-placeholder.jpg" alt="Prévisualisation de la couverture" class="book-cover-preview">
                    <label for="bookImageInput" class="change-photo">Choisir une photo</label>
                    <input type="file" name="image_url" id="bookImageInput" class="file-input" accept="image/*">
                </div>

                <!-- Colonne infos -->
                <div class="form-fields">
                    <label for="title">Titre</label>
                    <input type="text" id="title" name="title" value="<?= $this->clean($formData['title'] ?? '', false) ?>" required>

                    <label for="author">Auteur</label>
                    <input type="text" id="author" name="author" value="<?= $this->clean($formData['author'] ?? '', false) ?>" required>

                    <label for="description">Commentaire</label>
                    <textarea id="description" name="description" rows="8"><?= $this->clean($formData['description'] ?? '', false) ?></textarea>

                    <label for="is_available">Disponibilité</label>
                    <select name="is_available" id="is_available">
                        <option value="1" <?= (isset($formData['is_available']) && $formData['is_available'] == 1) ? 'selected' : '' ?>>disponible</option>
                        <option value="0" <?= (isset($formData['is_available']) && $formData['is_available'] == 0) ? 'selected' : '' ?>>non disponible</option>
                    </select>

                    <button type="submit" class="btn-green">Ajouter</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Tableau listant les livres ajoutés par l'utilisateur -->
<section class="profile-wrapper">
    <table id="books-table" class="books-table">
        <thead>
            <tr>
                <th>Photo de couverture</th>
                <th>
                    <a class="hover-link" href="<?= $this->url('/account', ['sort' => 'title', 'dir' => $this->toggleSort('title')]) ?>#books-table">
                        Titre <?= $this->sortIcon('title') ?>
                    </a>
                </th>
                <th>
                    <a class="hover-link" href="<?= $this->url('/account', ['sort' => 'author', 'dir' => $this->toggleSort('author')]) ?>#books-table">
                        Auteur <?= $this->sortIcon('author') ?>
                    </a>
                </th>
                <th>Description</th>
                <th>
                    <a class="hover-link" href="<?= $this->url('/account', ['sort' => 'is_available', 'dir' => $this->toggleSort('is_available')]) ?>#books-table">
                        Disponibilité <?= $this->sortIcon('is_available') ?>
                    </a>
                </th>
                <th class="th-actions">Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Affichage des livres existants (si présents) -->
            <?php if (!empty($books)): ?>
                <?php foreach ($books as $index => $book): ?>
                    <tr class="table-row <?= $index % 2 === 0 ? 'even' : 'odd' ?>">
                        <td>
                            <img src="<?= IMG_PATH . $this->clean($book['image_url'], false) ?>" alt="<?= $this->clean($book['title'], false) ?>" class="book-cover">
                        </td>
                        <td><?= $this->clean($book['title'], false) ?></td>
                        <td><?= $this->clean($book['author'], false) ?></td>
                        <td><?= $this->clean($this->truncate($book['description'], 10), false, $book['description']) ?></td>
                        <td>
                            <?php if ($book['is_available']): ?>
                                <span class="status available">disponible</span>
                            <?php else: ?>
                                <span class="status unavailable">non dispo.</span>
                            <?php endif; ?>
                        </td>
                        <td class="td-actions">
                            <a href="<?= $this->url('/account/book/edit/' . $book['id']) ?>" class="action edit">Éditer</a>
                            <form action="<?= $this->url('/account/book/delete/' . $book['id']) ?>" method="POST" style="display:inline;" onsubmit="return confirm('Supprimer ce livre ?');">
                                <button type="submit" class="action delete">Supprimer</button>
                            </form>
                        </td>
                    </tr>
                <?php endforeach; ?>
            <?php endif; ?>
        </tbody>
    </table>

</section>
<!-- Script pour afficher la modale automatiquement si nécessaire -->
<?php if (!empty($openModal)): ?>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('bookModal');
            if (modal) {
                modal.style.display = 'block';
            }
        });
    </script>
<?php endif; ?>